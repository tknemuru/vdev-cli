# Plan: vdev sync コピーを git 管理対象から除外

## Summary

vdev sync によって生成されるコピーファイルを git 管理対象から完全に外し、
.gitignore に追加することで、sync 実行後も git status がクリーンな状態を維持する。

## 対象ファイルの特定

### git 管理されている sync コピー

以下のファイルは AUTO-GENERATED マーカーを持つか、正本（system/adapters/claude/ または system/docs/）と完全一致する sync コピーである。

#### ルート直下
| ファイル | 正本 |
|---------|------|
| CLAUDE.md | system/adapters/claude/CLAUDE.md |
| vdev-flow.md | system/docs/flow/vdev-flow.md |

#### .claude/ 配下
| ファイル | 正本 |
|---------|------|
| .claude/commands/* | system/adapters/claude/commands/* |
| .claude/subagents/* | system/adapters/claude/subagents/* |
| .claude/knowledges/* | system/adapters/claude/knowledges/* (または system/knowledges/) |

#### cli/ 配下（monorepo サブディレクトリ）
| ファイル | 正本 |
|---------|------|
| cli/CLAUDE.md | system/adapters/claude/CLAUDE.md |
| cli/vdev-flow.md | system/docs/flow/vdev-flow.md |
| cli/.claude/commands/* | system/adapters/claude/commands/* |
| cli/.claude/subagents/* | system/adapters/claude/subagents/* |
| cli/.claude/knowledges/* | system/adapters/claude/knowledges/* |

## 実装手順

### Step 1: git 管理から削除

`git rm --cached` を使用してファイルをインデックスから削除する（ローカルファイルは保持）。

```bash
# ルート直下
git rm --cached CLAUDE.md vdev-flow.md

# .claude/ 配下
git rm -r --cached .claude/commands/ .claude/subagents/ .claude/knowledges/

# cli/ 配下
git rm --cached cli/CLAUDE.md cli/vdev-flow.md
git rm -r --cached cli/.claude/commands/ cli/.claude/subagents/ cli/.claude/knowledges/
```

### Step 2: .gitignore への追加

以下のパターンを .gitignore に追加する（限定的なパターンを使用）。

```gitignore
# vdev sync generated files (ephemeral, regenerated by vdev sync)
/CLAUDE.md
/vdev-flow.md
/.claude/commands/
/.claude/subagents/
/.claude/knowledges/
/cli/CLAUDE.md
/cli/vdev-flow.md
/cli/.claude/
```

### Step 3: コミット

削除と .gitignore 更新を 1 コミットにまとめる。

## DoD (Definition of Done)

1. sync コピーが git 管理対象から外れている（`git ls-files` で表示されない）
2. .gitignore により再追加されない
3. `vdev sync` を再実行しても `git status` がクリーンなままである
4. 開発フロー（vdev gate, vdev plan 等）が正常に動作する

## Verify コマンド

```bash
# 1. sync コピーが git 管理から外れていることを確認
git ls-files CLAUDE.md vdev-flow.md .claude/ cli/CLAUDE.md cli/vdev-flow.md cli/.claude/

# 2. vdev sync を実行
vdev sync

# 3. git status がクリーンであることを確認
git status --porcelain

# 4. vdev gate が正常動作することを確認
vdev gate 2026-01-26-remove-vdev-sync-copies-and-ignore
```

## 必須ドキュメント更新要否

| ドキュメント | 更新要否 | 理由 |
|-------------|---------|------|
| docs/spec.md | 不要 | 外部仕様への影響なし |
| docs/ops.md | 不要 | 運用手順への影響なし（sync コマンド自体は変更なし） |
| docs/arch.md | 不要 | 設計境界への影響なし |

本変更は git 管理ポリシーの変更であり、vdev システムの仕様・運用・設計には影響しない。

## Risk Assessment

- **R2（中）**: CI や開発ツールが sync コピーの存在に依存している可能性
  - 対策: Verify で vdev gate の動作を確認
- **R1（低）**: .gitignore のパターンが広すぎて意図しないファイルを ignore する
  - 対策: 具体的なパスパターンを使用し、glob を最小限にする
