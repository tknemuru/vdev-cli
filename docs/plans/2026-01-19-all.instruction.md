## Architecture Overview

### 構成

* **CLI層**：サブコマンド登録、共通出力（`REPO=...` プレフィックス）、exit code制御
* **core層**：純粋ロジック中心（slug、hash、LF正規化、meta read/validate/update、gate判定）
* **commands層**：I/O（stdin→ファイル保存、meta更新）、core呼び出し

### ディレクトリ（確定）

`~/projects/vdev-cli/`

* `src/cli.ts`
* `src/commands/{new,plan,review,gate,ls,run}.ts`
* `src/core/{slug,meta,hashes,normalize,time,repo,errors,gate,paths}.ts`
* `test/*`

---

## Options Considered

* bash：JSON更新とテストが辛いので却下
* Python：アリだが配布/導入がnpm linkと比べて重い
* **Node(TypeScript)**：JSON/FS/hash/stdin/テストが安定、採用

---

## Execution Plan for AI Tools

### Epic

**`vdev` を npm link でグローバル実行できる TypeScript CLI として実装し、仕様（spec/ops/rollback）とテストで固定する**

---

### Task 1：プロジェクト土台（TS/ビルド/テスト/グローバル実行）

* **Agent**：Claude Code（CLI）
* **変更範囲**：`~/projects/vdev-cli/` 新規作成
* **Steps**

  1. `~/projects/vdev-cli` を作成
  2. `package.json` 作成（重要：`bin.vdev` は `dist/cli.js` を指す）
  3. `tsconfig.json` 作成（dist出力）
  4. 依存追加：`commander`（CLI）、`vitest`（テスト）※最小
  5. `src/cli.ts` の最小起動（`vdev --help` が出る）
  6. `npm run build` で `dist/cli.js` が生成される
  7. `npm link` で `vdev` がグローバルに生える
* **DoD**

  * `cd ~/projects/vdev-cli && npm i && npm run build && npm link` が成功
  * どこでも `vdev --help` が動く
* **Verify**

  * `npm run build`
  * `node dist/cli.js --help`
  * `vdev --help`
* **Rollback**

  * `npm unlink -g vdev-cli`（実体に合わせて）+ ディレクトリ削除
* **Risks**

  * ESM/CJSの混在でbin実行が壊れる → 早期に統一（CJS推奨で事故少）

---

### Task 2：coreユーティリティ（純粋ロジック）実装

* **Agent**：Claude Code（CLI）
* **変更範囲**：`src/core/*`
* **Steps**

  1. `slug.ts`：topic→slug正規化（合意ルール・最大48・空ならuntitled）
  2. `time.ts`：JSTのISO文字列生成
  3. `normalize.ts`：stdin取得、LF正規化（CRLF→LF）
  4. `hashes.ts`：sha256算出（plan/review用）
  5. `repo.ts`：repo名表示用（git toplevel basename / 失敗なら `-`）
  6. `errors.ts`：exit code定義（gate: 0/10-14/20、new/plan/review/lsも）
  7. `paths.ts`：`docs/plans/<topic>/...` のパス解決（topicをそのまま受ける）
* **DoD**

  * core関数が独立してテスト可能
* **Verify**

  * ユニットテスト（slug、normalize、hashes、repoのnogitケース）
* **Rollback**

  * revert
* **Risks**

  * JST時刻生成の取り扱い（Node標準だけで確実に）→ `Intl.DateTimeFormat` or offset固定で慎重に

---

### Task 3：meta.json（read/validate/update）実装

* **Agent**：Claude Code（CLI）
* **変更範囲**：`src/core/meta.ts`
* **Steps**

  1. schemaVersion=1 の型定義
  2. `readMeta(topicDir)`：存在/JSONパース
  3. `validateMeta(meta, topicDirName)`：

     * schemaVersion対応
     * meta.topic一致
     * pathsの妥当性（instruction/plan/review固定）
  4. `writeMeta(topicDir, meta)`：LF/整形（JSON pretty print）で保存
  5. 更新ユーティリティ：`touchUpdatedAt`, `setStatus`, `setPlanHash`, `setReviewHash`
* **DoD**

  * meta.json を安全に読み書き・検証できる
* **Verify**

  * meta.json の不正ケースで `BROKEN_STATE(20)` に繋げられる
* **Rollback**

  * revert
* **Risks**

  * validateを緩くしすぎると事故増 → gate用に必要十分な厳密さを維持

---

### Task 4：gate判定ロジック（決定表・exit code固定）

* **Agent**：Claude Code（CLI）
* **変更範囲**：`src/core/gate.ts` + `src/commands/gate.ts`
* **Steps**

  1. 判定表を実装（優先順位：BROKEN→NEEDS_INSTRUCTION→NEEDS_PLAN→NEEDS_REVIEW→REJECTED→APPROVED→NEEDS_CHANGES）
  2. APPROVED/REJECTED の整合性チェック

     * plan/review sha256一致必須
     * instruction hash は不使用（確定事項）
  3. 出力フォーマット：`STATE\tTOPIC\tmessage`

     * CLI層で `REPO=...` を先頭付与
  4. exit code を仕様通りに返す
* **DoD**

  * `vdev gate <topic>` が仕様通りの出力とexit code
* **Verify**

  * テストで主要分岐を固定（後述Task8でも強化）
* **Rollback**

  * revert
* **Risks**

  * “APPROVEDなのにhash不一致”の扱い：必ず `BROKEN_STATE(20)`（確定）

---

### Task 5：`vdev new` 実装（topic作成＋instructionテンプレ＋meta初期化）

* **Agent**：Claude Code（CLI）
* **変更範囲**：`src/commands/new.ts` + テンプレ（`src/templates/*`）
* **Steps**

  1. 引数 `<topic...>` から slug生成、title決定
  2. `docs/plans/YYYY-MM-DD-slug/` を作る（衝突なら `-2` 付与）
  3. `instruction.md` をテンプレで生成（末尾に Output Contract を埋め込む）
  4. `meta.json` を初期生成

     * status=NEEDS_CHANGES
     * plan/review hash 空
     * timestamps created/updated JST
  5. stdout：`CREATED\t<topic>\t<path>`（前に `REPO=`）
* **DoD**

  * `vdev new foo bar` で topic dir + instruction + meta ができる
* **Verify**

  * `vdev new auth refresh`
  * `cat -A instruction.md` でLFのみ
  * `meta.topic == dirName`
* **Rollback**

  * 作ったtopic dir削除
* **Risks**

  * 日本語のみ入力→slug untitled（仕様通り）。titleに保持されることを確認

---

### Task 6：`vdev plan --stdin` 実装（保存器＋status失効）

* **Agent**：Claude Code（CLI）
* **変更範囲**：`src/commands/plan.ts`
* **Steps**

  1. 前提：topic dir / meta / instruction / stdin非空 を検証
  2. stdin をLF正規化して `plan.md` に保存
  3. sha256算出→`meta.hashes.planSha256` 更新
  4. **meta.status を強制 NEEDS_CHANGES**（承認失効）
  5. updatedAt更新、meta保存
  6. stdout：`SAVED_PLAN\t...`
* **DoD**

  * plan保存で必ずNEEDS_CHANGESになる
* **Verify**

  * APPROVED状態にした後 plan再保存→ statusがNEEDS_CHANGESへ落ちる
* **Rollback**

  * plan.md削除 or git revert（後でrepo組み込みなら）
* **Risks**

  * stdin空を見逃すと事故 → exit 5/4で確実に止める

---

### Task 7：`vdev review --stdin` 実装（抽出失敗でも保存＋整形＋meta更新）

* **Agent**：Claude Code（CLI）
* **変更範囲**：`src/commands/review.ts`
* **Steps**

  1. 前提：topic dir / meta / plan.md / stdin非空
  2. stdin から Status抽出（先頭20行→全文救済、enum正規化）
  3. **抽出失敗でも保存**：

     * review.md 先頭に `Status: NEEDS_CHANGES` を挿入
     * stderrにWARN
  4. review.md を整形（Status行を先頭へ、Summary無ければ2行目に挿入）
  5. sha256算出→`meta.hashes.reviewSha256` 更新
  6. status更新（成功なら抽出値、失敗ならNEEDS_CHANGES）
  7. plan hash 不一致検知時：保存はするが statusをNEEDS_CHANGESに強制 + WARN
  8. updatedAt更新、meta保存
* **DoD**

  * Status無しでも review.md が保存され、metaがNEEDS_CHANGESになる
* **Verify**

  * Status無し入力でWARNが出ること、gateでAPPROVEDにならないこと
* **Rollback**

  * review.md削除/上書き
* **Risks**

  * 整形のやりすぎで原文が変わる → “最小整形”に限定（Status/ Summaryのみ）

---

### Task 8：`vdev ls` と `vdev run` 実装（一覧と許可証）

* **Agent**：Claude Code（CLI）
* **変更範囲**：`src/commands/ls.ts` `src/commands/run.ts`
* **Steps**

  1. `ls`：`docs/plans/*/meta.json` 走査

     * updatedAt desc
     * 出力：`topic\tstatus\ttitle\tupdatedAt`（前に`REPO=`）
     * meta壊れは `BROKEN` 表示（末尾）
  2. `run`：`gate` を内部呼び出しして `APPROVED` のときだけ exit 0（許可証）
* **DoD**

  * `vdev ls` が期待通り表示
  * `vdev run` がAPPROVED以外で通らない
* **Verify**

  * ダミートピック複数で並び順確認
  * gate結果に応じてrunが通る/落ちる
* **Rollback**

  * revert
* **Risks**

  * ls走査の例外で落ちないように（壊れはBROKEN表示）

---

### Task 9：Repo名表示（stdout prefix）を全コマンドに一括適用

* **Agent**：Claude Code（CLI）
* **変更範囲**：`src/cli.ts`（共通出力ヘルパ）
* **Steps**

  1. stdout出力を必ず共通関数経由にする
  2. 共通関数で `REPO=<name>\t` を先頭付与
  3. stderrはそのまま（WARN/ERRORの視認性確保）
* **DoD**

  * 全コマンドのstdoutが `REPO=` で始まる
* **Verify**

  * `vdev --help`（可能ならhelpにも付けるかは任意。付けないなら仕様に明記）
  * `vdev ls` / `vdev gate` / `vdev new` 出力確認
* **Rollback**

  * revert
* **Risks**

  * help出力との相性 → helpは例外扱いでもOK（ただし仕様化）

---

### Task 10：テスト（品質ゲート：重要ロジック固定）

* **Agent**：Claude Code（CLI）
* **変更範囲**：`test/*`
* **Steps**

  1. slug正規化テスト（日本語→untitled、記号処理、最大長）
  2. plan保存でstatus失効テスト
  3. reviewのStatus抽出失敗→保存＆NEEDS_CHANGES強制テスト
  4. gate判定表テスト：主要状態（NEEDS_PLAN/NEEDS_REVIEW/APPROVED/REJECTED/BROKEN_STATE）
  5. lsのソート（updatedAt desc）テスト（簡易）
* **DoD**

  * `npm test` が通る
* **Verify**

  * `cd ~/projects/vdev-cli && npm test`
* **Rollback**

  * revert
* **Risks**

  * テストがI/Oに依存しすぎる → temp dirで閉じる

---

### Task 11：ドキュメント（spec/ops/rollback）を `~/projects/vdev-cli/docs/` に置くか、別管理方針を決める

* **Agent**：Claude Code（CLI）
* **変更範囲**：`~/projects/vdev-cli/docs/*`
* **Steps**

  1. 先に作った雛形をベースに、今回確定した仕様を反映
  2. npm link手順、dist実行、ビルド更新手順を setup/ops に明記
* **DoD**

  * `docs/vdev-spec.md` が唯一の正として機能
  * `docs/ops.md` で迷わず運用できる
* **Verify**

  * 人間レビュー（目視）
* **Rollback**

  * revert
* **Risks**

  * vdev-cliがrepo外にあるためdocsが散る懸念 → “どこに置くか”はこのTaskで明記して固定

---

## Quality Gates

* **テスト方針**：状態機械（gate）、正規化（slug/LF）、承認失効（plan→NEEDS_CHANGES）、Status抽出失敗の救済（review）を最優先でテスト
* **最小テストセット**：Task10の1〜4は必須
* **Docコメント（日本語）**：core/commandsの公開関数に日本語Docコメント（目的/入力/出力/失敗条件）
* **docs成果物**：spec/ops/rollback（vdev-cli側に置く方針で）

---

## Risk & Trade-offs

* グローバル（npm link）運用は快適だが、誤repo操作の可能性は残る
  → その代わり **REPO表示のみ**で自己検知（方針通り）
* dist実行は安定だが、変更のたびに build が必要
  → 個人運用なら許容。必要なら `npm run build -- --watch` を後で追加
* vdev-cliがrepo外なので、プロジェクト側の履歴と分離する
  → 個人運用としてはOK。将来チーム化するなら配置見直し余地あり

---

### Claude Code への実行指示（貼り付け用）

* `~/projects/vdev-cli` に Node(TypeScript) のCLIを作成
* `npm link` + `dist/cli.js` 実行を前提に `bin.vdev` を設定
* コマンド：`new / plan --stdin / review --stdin / gate / ls / run`
* 仕様：meta.json schemaVersion=1、gate判定表/exit code、plan保存でstatus失効、reviewはStatus無しでも保存（NEEDS_CHANGES強制 + WARN）
* stdout 先頭に `REPO=<repoName>\t` を必ず付与（git外なら `-`）
* Git root検出/ docs/plans存在チェックは行わない（表示のみ）

---

